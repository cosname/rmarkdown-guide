
# 文档元素

学习过 R Markdown 的基础知识后，本章进一步介绍如何创建和自定义常见的文档元素，包括

- 处理文档中的图片，表格和数学公式

- 用主题定制输出外观

- 插入目录

- 创建交叉引用

- 设置章节编号

- 插入文献参考和引用

- 创建示意图

- 插入分页符和分割线



## 图片

### 用 knitr 选项操作图片

默认设置下，代码块产生的图片被直接插入到输出文档中该段代码的后面，靠左对齐，没有标题, 尺寸默认大小。我们可以用 `fig.align`, `fig.cap`, `fig.width`, `fig.height`, `out.width`, `out.height` 等 knitr 选项操作图片。例如：

````
```{r, out.width = '70%', fig.align = 'center', fig.cap = 'cars 散点图'}`r ''`
plot(cars)
```
````


生成

```{r, out.width = '70%', fig.align = 'center', fig.cap = 'cars 散点图', echo = FALSE}
plot(cars)
```

`fig.cap` 是图片的重要属性，它不仅为图片设置了标题，还确保图片被置于独立的环境中。对 HTML 输出，图片对应的 `<img>` 标签被放在一个 `.figure` 类 div 容器中。对 PDF 输出，Pandoc 会创建 `\begin{figure}` 环境，而不是仅插入 `\includegraphics{}` 指令。添加标题可以让我们的文档更有组织性，并支持交叉引用 (\@ref(cross-reference))

我们可以把多个图片放置在同一个环境中。knitr 选项 `fig.show = 'hold'` 把同一个代码块生成的多个图片放到同一个图片环境中。我们可以进一步设置 `out.wdith` 使多个图片并排放置。例如，`out.width = '50%'` 可以让一个代码块生成的两张图片位于一行。类似的，如果想并排 3 张图片，可以设置 `out.width = '33%'`。图 \@ref(fig:plots-side-by-side) 是用 `fig.show = "hold"` 和 `out.width = '50%'` 并排两张图片的例子。

```{r plots-side-by-side, fig.cap = "用 fig.show 和 out.width 并排摆放多个图片", fig.show = "hold", out.width = "50%"}
par(mar = c(4, 4, 0.1, 0.1))
plot(pressure, pch = 19, type = "b")
plot(cars, pch = 19)
```

我们在第 \@ref(r-code) 节提到过 `fig.width`, `fig.height` 和 `out.width`, `out.height` 的区别。前两者控制了 R 用图形设备创建图片时的大小，而后两者控制了图片 (按照 `fig.width` 和 `fig.height`生成后) 插入输出文档时的比例。例如，`out.width = '70%'` 时, HTML 输出中的 `<img>` 标签添加了属性 `width = '70%'`，而 PDF 输出设置了 `.7\linewidth`


另一个和图片大小有关的 knitr 选项是 `dpi`。当我们不设置 `out.width` 时，`dpi` 是图片的像素与宽度 (英寸) 之比。 默认情况下。knitr 会自动计算 dpi 值，我们可以用 `include_graphics(dpi = NA)`取消自动计算。




### 插入非代码生成图片


对于已有的，非代码块生成的图片，有两种插入方法

- 使用 `knitr::include_graphics()` 函数，例如 


````
```{r, fig.cap = "加载非代码块生成的图片", out.width = '90%'}`r ''`
# <image-path> 为图片的存储路径
knitr::include_graphics("<image-path>")
```
````

- 使用 Markdown 语法 `![文字](图片链接)`，

我们推荐总是用 `knitr::include_graphics()` 插入图片，它有几点好处

- 提供独立于输出格式的统一图片语法

- 我们可以像控制 R 代码生成的图片那样控制外部图片，`fig.cap`, `out.width`, `dpi`, `fig.show` 等图片相关的 knitr 选项均适用于 `include_graphics` 加载的图片。在后面的章节中，我们会学习如何用钩子函数自动裁剪图片，优化图片体积等，而这一切都要求图片必须在代码段生成。

- 对于 PDF 输出，`include_graphics` 能自动采用质量更高的 PDF 格式图片，例如用 `foo/bar.pdf` 取代 `foo/bar.png`。knitr 选项 `auto_pdf = TRUE` 可以启动这项功能，或设置全局选项 `options(knitr.graphics.auto_pdf = TRUE)。`


`include_graphics` 可以一次插入多个图片，下面的代码块插入了三张图片，并设置 `out.width = '33%'` 和 `fig.show = "hold"`：

```{r, out.width = "33%", fig.show = "hold"}
knitr::include_graphics(rep("images/knit-logo.png", 3))
```




## 表格

使用 `knitr::kable` 是在 R Markdown 中插入表格的最简单方式，它提供了一些修饰表格的参数

- `caption`: 标题

- `row.names` 和 `col.names`: 覆盖原有的行/列名

- `digits`: 数值类型列的取整小数位

- `booktabs`: 应用 booktabs 样式 (PDF)

- `longtable`: 把较长的表格拆分至多页 (PDF, 需要 LaTeX 包 `longtable`)

```{r}
knitr::kable(head(mtcars[, 1:8], 10), 
             caption = "mtcars 数据的前 10 行", booktabs = TRUE)
```

与图片类似，带标题的表格将获得独立的环境。我们可以把多个表格放入同一个环境，如图 \@ref(tab:two-tables-same-env) 所示。

```{r two-tables-same-env}
knitr::kable(
  list(
    head(iris[, 1:2], 3),
    head(mtcars[, 1:3], 5)
  ),
  caption = 'A Tale of Two Tables.', booktabs = TRUE
)
```

[kableExtra](https://github.com/haozhu233/kableExtra) [@R-kableExtra]  包 在 `knitr::kable` 基础上提供了更多定制表格外观的参数, 提供了 `kableExtra::kbl` 函数作为 `kable` 的升级版。我们可以用很少的代码创作出外形美观，意义丰富的表格。 


```{r kableExtra-example}
library(kableExtra)

mtcars[1:8, 1:8] %>%
  kbl() %>%
  kable_paper(full_width = F) %>%
  column_spec(2, color = spec_color(mtcars$mpg[1:8]),
              link = "https://haozhu233.github.io/kableExtra/") %>%
  column_spec(6, color = "white",
              background = spec_color(mtcars$drat[1:8], end = 0.7),
              popover = paste("am:", mtcars$am[1:8]))
```

读者还可以查看 [gt](https://github.com/rstudio/gt)， [huxtable](https://github.com/hughjonesd/huxtable)， [https://github.com/glin/reactable](https://github.com/glin/reactable)。RStudio 举办的[表格创作比赛](https://blog.rstudio.com/2020/12/23/winners-of-the-2020-rstudio-table-contest/) (Table Contest) 有很多优秀的获奖作品。



## 公式

我们可以用一对 `$` 插入行内数学公式，例如 `$f(k) = {n \choose k} p^{k} (1-p)^{n-k}$` 渲染为 $f(k) = {n \choose k} p^{k} (1-p)^{n-k}$。

前后各两个 `$$` 会创建块状公式，例如

```
$$
f(k) = {n \choose k} p^{k} (1-p)^{n-k}
$$
```

输出为

$$
f(k) = {n \choose k} p^{k} (1-p)^{n-k}
$$

我们可以使用 LaTeX 默认的数学环境，如：


```
$$\begin{array}{ccc}
x_{11} & x_{12} & x_{13}\\
x_{21} & x_{22} & x_{23}
\end{array}$$
```

$$\begin{array}{ccc}
x_{11} & x_{12} & x_{13}\\
x_{21} & x_{22} & x_{23}
\end{array}$$


```
$$X = \begin{bmatrix}1 & x_{1}\\
1 & x_{2}\\
1 & x_{3}
\end{bmatrix}$$
```

$$X = \begin{bmatrix}1 & x_{1}\\
1 & x_{2}\\
1 & x_{3}
\end{bmatrix}$$

## 主题

对于 rmarkdown 包提供的 HTML 输出格式，我们可以用 YAML 元数据中的 `theme` 选项设置输出的外观主题。

```
--- 
output:
  html_document:
    toc: true
    theme: united
---
```

一个主题包含了一系列配色，字体，布局等设置。图 


```{r, echo = FALSE}
import_example_result("examples/theme-united.Rmd")
```



可选的主题包括 `united`, `journal`, `flatly` 等 。这些名字来自 UI 框架 bootstrap 的主题扩展 [bootswatch](https://bootswatch.com/)。R Markdown 的默认 HTML 输出格式基于 bootstrap 库，而 bootswatch 提供了一系列扩展主题。读者可以在 bootswatch 网站上看到每个主题的效果。Andrew Zieffler 在[博客](https://www.datadreaming.org/post/r-markdown-theme-gallery/)中同样列举了所有主题的效果。

```{r boots-theme, fig.cap = "bootswatch 网站", echo = FALSE}
knitr::include_graphics("images/04-bootswatch.jpg")
```

除了 `theme` 提供的主题选择之外，读者还可以使用其他包提供的 R Markdown 模板。一个例子是 [prettydoc](https://github.com/yixuan/prettydoc) 包，


```{r, echo = FALSE}
import_example_result("examples/prettydoc.Rmd")
```



一些类似的提供 R Markdown 模板的包包括 [rmdformats](https://github.com/juba/rmdformats)，[tufte](https://github.com/rstudio/tufte)，[rtciles](https://github.com/rstudio/rticles) (PDF) 等。


## 目录

我们可以设置任意输出格式的 `toc: true` 以自动生成目录，`toc_depth` 控制显示深度。如 ：

```
---
title: "插入目录"
output:
  html_document:
    toc: true
    toc_depth: 2
---
```

此时目录只会显示一级标题和二级标题，略过级别更低的标题。

`html_document` 和 `bookdown::html_document2` 等输出格式支持 `toc_float` 属性，为 `true` 时，目录变为侧边栏，并固定在屏幕左侧。我们可以展开 `toc_float` 为一个字典，包括

- `collapsed` (默认为 `true`)：是否折叠二级标题以下的标题

- `smooth_scroll` (默认为 `true`)：是否在鼠标点击目录时添加平滑滚动

设置样例如下：


```
---
title: "插入目录"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
---
```


## 交叉引用 {#cross-reference}

交叉引用 (cross-reference) 可以为读者提供锚点链接，便于他们快速浏览文档中相关部分。为了使用交叉引用，我们需要

- 支持交叉引用的格式：交叉引用不是 R Markdown 问世时就具备的功能，rmarkdown 包中的 `html_document`, `pdf_document` 等格式不能支持。我们可以使用 bookdown 包中的"增强版本"：`bookdown::html_document2` 和 `bookdown::pdf_document2` 等。

- 为链接到的锚点设置标签 (label）：对于章节，我们可以使用 Pandoc 生成的标签。对于图片和表格，我们在 \@ref(r-code) 节中谈到可以用 `  ```{r label} ` 和 `  ```{r, label = "label"}` 为代码块设置标签。当该代码块的输出包含图片或表格时，代码块的标签即是引用时用到的标签。我们还需要为图片或表格设置标题。图片可以用`fig.cap` knitr 选项，设置表格标题的方法取决于生成的函数，例如 `knitr::kable` 使用 `caption` 参数

随后，我们可以用 `\@ref(label)` 引用章节，用 `\@ref(fig:label)` 引用图片，用 `\@ref(tab:label)` 表格。下面是一个例子：

`r import_example("examples/cross-reference.Rmd")`


输出结果为

```{r, echo = FALSE}
import_example_result("examples/cross-reference.Rmd")
```


如上所示，我们可以用 `# 标题 {#header}` 为该节添加自定义标签，随后用 `\@ref(header)` 引用该部分。图片和表格的标签即是该代码块的标签，同时需要有 标题属性，交叉引用才能生效。R Markdown 会自动为标题，图片和表格生成顺序编号，我们在引用时只关心它们的标签即可。

读者如果点开生成的 HTML 文档，可以发现设置了标签的元素有对应的`id`属性，这也是交叉引用的跳转基础。对于英文标题，Pandoc 会自动设置一个标签。例如 `# Hello World` 对应的标签为 `hello-world`。对中文标题，我们建议在需要时手动设置一个简洁的英文标签，仅包含英文字母和连字符。

除了 `\@ref(label)` 以外，我们还可以用 Markdown 的链接语法 `[文字](#label)` 设置交叉引用。这种办法的好处是可以添加自定义文字，而 \@ref(label) 仅生成对应编号。



## 章节编号

绝大多数输出格式在 YAML 元数据中支持 `number_sections` 属性，值为 `true` 时，各章节标题按照层级自动编号。

我们可以用 Pandoc 的标题属性 `.unnumbered` 省略某个章节的编号，见 <https://pandoc.org/MANUAL.html#extension-header_attributes>。


`r import_example("examples/pandoc-attributes.Rmd")`


以上文档输出为 


```{r, echo = FALSE}
import_example_result("examples/pandoc-attributes.Rmd")
```

读者还需注意，对没有编号的标题使用交叉引用时，只能用 Markdown 链接 `[文字](#label)`,  而不能用 `\@ref(label)`，后者是基于编号的引用。 





## 参考文献和引用

R Markdown 支持在输出文档末尾自动生成参考文献，并提供了很方便的引用格式。这项功能是通过 Pandoc 实现的，它有两种管理引用和参考文献的方式

1. 默认情况下，Pandoc 会使用 `[pandoc-citeproc](https://github.com/jgm/pandoc-citeproc)` 程序按照 CSL (Citation Style Language) 语言的标准和特定的 CSL 风格文件组织参考文献和引用的格式。

2. 读者还可以使用 [natbib](https://ctan.org/pkg/natbib) 包 (基于 LaTeX 的 `bibtex`包) 或 [biblatex](https://ctan.org/pkg/biblatex) 包提供的格式。此时我们需要参考的数据文件符合 `bibtex` 或 `biblatex` 格式。

我们可以用 YAML 元数据中的 `citation_package` 选项选择 `natlib` 或 `biblatex`  

```
---
output:
  pdf_document:
    citation_package: natbib
  bookdown::pdf_book:
    citation_package: biblatex
---
```

读者需注意，`citation_package` 仅限于 PDF 输出格式。对其他输出格式，我们只能依靠 `pandoc-citeproc`，如果需要保持 PDF 格式和其他格式的一致性，就应该始终使用 `pandoc-citeproc`。

设置好格式后，我们需要知道如何从数据上表达参考文献的各个条目。我们在这里以 BibTeX 数据库的方法为例。一个 BibTeX 数据库是一种用于存储参考文献数据的纯文本文件，后缀为 `bib`，每一个条目都至少包含名称，作者和时间等信息，格式形如


```
@Manual{R-base,
  title = {R: A Language and Environment for Statistical
    Computing},
  author = {{R Core Team}},
  organization = {R Foundation for Statistical Computing},
  address = {Vienna, Austria},
  year = {2016},
  url = {https://www.R-project.org/},
}
```

一个条目以 `@type{` 开始，`type` 表示该条参考的类型，可以识 `article`, `book`, `manual` 等。在类型之后的是引用标签，如 `R-base`，其他项包含参考的作者，组织，地址，日期和链接等信息。为了使用 `.bib` 文件中的条目，我们需要用 YAML 元数据中的 `bibliography` 加载一个或多个 `.bib` 文件：

```
---
output: pdf_document
bibliography: ["one.bib", "another.bib", "yet-another.bib"]
biblio-style: "apalike"
link-citations: true
---
```

在上面的例子中，我们引入了 `one.bib`，`another.bib`，`yet-another.bib`  三个 `.bib` 文件中的参考数据，`biblio-style: 'apalike'` 设置参考样式为美国心理学学会期刊样式 (American Psychology Association, APA)，`link-cations: true` 为引用添加指向参考文献的跳转链接。

用 `bibliography` 引入 `.bib` 后，我们可以在文档中引用其中包含的任意条目，语法为 `@key` 或 `[@key]`，其中 `key` 为该参考条目类型之后的标签。如 `@R-base` 生成为 @R-base，而 `[@R-base]` 生成 [@R-base]。 

对 PDF 输出，Pandoc 会在最后一个章节后额外生成一节放置参考文献。对其他输出格式，我们可以用行内代码自动创建一节参考文献。例如，在源文档的最后插入：

```
`r if (knitr::is_html_output()) '# 参考文献 {-}'`
```

### 引用 R 包

参考"文献"还可以包括文章使用的软件包。knitr 提供了 `write_bib` 函数为 R 包生成 `.bib` 格式的参考条目： 


```{r}
# 第二个参数可以是任意 .bib 文件
knitr::write_bib(c("base", "knitr", "rmarkdown"), "", width = 60)
```

不提供第一个参数时。`write_bib` 会导出当前进程加载的全部 R 包的引用数据。我们可以在文档末尾插入如下代码段自动化生成 R 包对应的 `.bib` 文件：


````
---
bibliography: [packages.bib, references.bib]
---


# 总结

最后，...


```{r, include=FALSE}`r ''`
knitr::write_bib(file = 'packages.bib')
```

`r if (knitr::is_html_output()) '# References {-}
````


## 插入示意图

## 插入分页符和分割线


